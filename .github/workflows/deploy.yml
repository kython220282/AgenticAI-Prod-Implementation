name: Deploy to Production

# ==============================================================================
# DEPLOYMENT WORKFLOW - REQUIRES INFRASTRUCTURE SETUP
# ==============================================================================
#
# ‚ö†Ô∏è  CURRENTLY DISABLED - Manual deployment only via workflow_dispatch
#
# This workflow is for production deployment and requires infrastructure setup.
# It is DISABLED by default for template users.
#
# TO ACTIVATE AUTOMATED DEPLOYMENT:
# ==================================
#
# STEP 1: SET UP INFRASTRUCTURE
# ------------------------------
# ‚ñ° Provision production server (AWS EC2, DigitalOcean, etc.)
# ‚ñ° Install Docker and docker-compose on the server
# ‚ñ° Clone repository to server: /opt/agenticai
# ‚ñ° Set up firewall rules (ports 80, 443, 22)
# ‚ñ° Configure domain DNS to point to server IP
# ‚ñ° Install SSL certificates (Let's Encrypt recommended)
#
# STEP 2: CONFIGURE SSH ACCESS
# ----------------------------
# ‚ñ° Generate SSH key pair: ssh-keygen -t ed25519 -C "github-actions"
# ‚ñ° Add public key to server: ~/.ssh/authorized_keys
# ‚ñ° Test SSH connection: ssh user@your-server.com
# ‚ñ° Keep private key for GitHub Secrets (next step)
#
# STEP 3: ADD GITHUB SECRETS
# --------------------------
# Go to: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret
#
# Required secrets:
# ‚ñ° PRODUCTION_HOST: Your production server IP or hostname
# ‚ñ° PRODUCTION_USER: SSH username (e.g., ubuntu, deploy)
# ‚ñ° PRODUCTION_SSH_KEY: Private SSH key (paste entire key including headers)
#
# Optional secrets (for staging environment):
# ‚ñ° STAGING_HOST: Staging server IP or hostname
# ‚ñ° STAGING_USER: SSH username for staging
# ‚ñ° STAGING_SSH_KEY: Private SSH key for staging
# ‚ñ° SMOKE_TEST_API_KEY: API key for post-deployment smoke tests
#
# STEP 4: UPDATE DEPLOYMENT CONFIGURATION
# ---------------------------------------
# In this file, update the following:
# ‚ñ° Line 115, 138: Replace 'agenticai.example.com' with your domain
# ‚ñ° Line 86, 112: Replace '/opt/agenticai' if using different path
# ‚ñ° Verify docker-compose.yml matches your configuration
#
# STEP 5: ENABLE AUTO-DEPLOYMENT
# ------------------------------
# In this file, uncomment lines 74-77 (the 'push:' trigger)
# This will enable automatic deployment on push to main branch
#
# STEP 6: TEST MANUAL DEPLOYMENT FIRST
# ------------------------------------
# ‚ñ° Go to: Actions ‚Üí Deploy to Production ‚Üí Run workflow
# ‚ñ° Select 'staging' or 'production'
# ‚ñ° Monitor the deployment
# ‚ñ° Verify application is running: https://your-domain.com/health
#
# STEP 7: VERIFY AUTOMATED DEPLOYMENT
# -----------------------------------
# ‚ñ° Make a small change and push to main branch
# ‚ñ° Watch Actions tab for automatic deployment
# ‚ñ° Check deployment logs for any issues
# ‚ñ° Verify rollback works if deployment fails
#
# TROUBLESHOOTING:
# ---------------
# - SSH connection fails: Check firewall rules and SSH key permissions
# - Docker build fails: Test docker-compose build locally first
# - Health check fails: Check application logs: docker-compose logs
# - See docs/DEPLOYMENT.md for detailed troubleshooting guide
#
# ==============================================================================

# DEPLOYMENT TRIGGERS - CURRENTLY DISABLED FOR TEMPLATE USERS

on:
  # ============================================================================
  # AUTOMATIC DEPLOYMENT (DISABLED)
  # ============================================================================
  # Uncomment the lines below AFTER completing all setup steps above
  # This will trigger deployment automatically when pushing to main branch
  #
  # push:
  #   branches: [ main ]
  #   tags:
  #     - 'v*.*.*'
  # ============================================================================
  
  # MANUAL DEPLOYMENT (ENABLED)
  # Use this to test deployment before enabling automatic triggers
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Build and push Docker image
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ steps.meta.outputs.version }}

  # Deploy to staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.agenticai.example.com
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to staging server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/agenticai
            docker-compose pull
            docker-compose up -d
            docker-compose exec -T api alembic upgrade head
      
      - name: Health check
        run: |
          sleep 10
          curl -f https://staging.agenticai.example.com/health || exit 1

  # Deploy to production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://agenticai.example.com
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Create backup
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/agenticai
            ./scripts/backup.sh
      
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/agenticai
            docker-compose pull
            docker-compose up -d --no-deps api worker
            docker-compose exec -T api alembic upgrade head
      
      - name: Health check
        run: |
          sleep 15
          curl -f https://agenticai.example.com/health || exit 1
      
      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/agenticai
            ./scripts/rollback.sh
      
      - name: Notify on success
        if: success()
        run: echo "Production deployment successful! üöÄ"

  # Database migrations
  migrate-production:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Run Alembic migrations
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/agenticai
            docker-compose exec -T api alembic upgrade head
            docker-compose exec -T api alembic current

  # Smoke tests
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run smoke tests
        env:
          API_URL: https://agenticai.example.com
          API_KEY: ${{ secrets.SMOKE_TEST_API_KEY }}
        run: |
          # Health check
          curl -f $API_URL/health
          
          # API docs accessible
          curl -f $API_URL/docs
          
          # Metrics endpoint
          curl -f $API_URL/metrics
          
          echo "Smoke tests passed! ‚úÖ"
